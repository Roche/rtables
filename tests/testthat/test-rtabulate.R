context("rtabulate")

cells <- function(x) as.vector(unlist(lapply(rtables:::collect_leaves(x, add.labrows=TRUE), rtables:::row_values)))

test_that("rtabulate length tests", {
  
    ##cells <- function(x) as.vector(unlist(unclass(x))) # current implementation
 
  
  cb <- letters[1:2]
  cbf <- factor(cb, levels = cb)
  
  rt_test <- function(x) {
    tbl <- rtabulate(x, cbf, length)
    expect_true(all(cells(tbl) == 1), "subset fail")
    
    tbl <- rtabulate(x[1], cbf[1], length)
    expect_identical(cells(tbl), c(1L, 0L), "0 count")
    
    tbl <- rtabulate(numeric(0), cbf[c(FALSE, FALSE)], length)
    expect_identical(cells(tbl), c(0L, 0L), "0 count 2")
  }
  
  
  rt_test(seq_along(cb)) # numeric
  rt_test(rep(TRUE, length(cb))) # logical
  # factor
  
  tbl <- rtabulate(cbf, cbf)
  expect_identical(cells(tbl), c(1L, 0L, 0L, 1L), "factor")
  
  tbl <- rtabulate(factor(c("X", "X"), c("X", "Y")), cbf) ##, length)
  expect_identical(cells(tbl), c(1L, 1L, 0L, 0L), "factor")
  
  tbl <- rtabulate(factor(c("X", "Y"), c("X", "Y")), factor(c("a", "a"), c("a", "b"))) ##, length)
  expect_identical(cells(tbl), c(1L, 0L, 1L, 0L), "factor")
  
  tbl <- rtabulate(factor(c("Y", "Y"), c("X", "Y")), factor(c("b", "b"), c("a", "b")))#, length)
  expect_identical(cells(tbl), c(0L, 0L, 0L, 2L), "factor")
  
  
})




  
## get_elmts <- function(x, i) {
##     stopifnot(is(x, "rtable") && nrow(x) == 1)
##     as.vector(sapply(x[[1]], `[[`, i))
##   }
  
##   check_row1 <- function(x) {
##     expect_identical(get_elmts(x, 2), c(3, 2, 1))
##     expect_identical(get_elmts(x, 3), LETTERS[1:3])
##   }
  
##   tbl1 <- rtabulate(1:3, factor(letters[1:3]), function(xi, a, b) {
##     list(xi, a, b)
##   }, col_wise_args = list(a = c(3, 2, 1), b = LETTERS[1:3]), row.name = "-")
## > tbl1
##             a              b              c   
## ----------------------------------------------
## -        1, 3, A        2, 2, B        3, 1, C  


test_that("rtabulate: col_wise_args argument", {
  
    get_elmts <- function(x, i) {
        as.vector(sapply(rtables:::row_values(x), '[[', i))
    }
  
    check_row1 <- function(x) {
        stopifnot(is(x, "VTableTree") && nrow(x) == 1)
        rw = collect_leaves(x, add.labrows = TRUE)[[1]]
        if(!is(rw, "LabelRow")) {
            expect_identical(get_elmts(rw, 2), c(3, 2, 1))
            expect_identical(get_elmts(rw, 3), LETTERS[1:3])
        }

    }
  
  tbl1 <- rtabulate(1:3, factor(letters[1:3]), function(xi, a, b) {
    rcell(list(xi, a, b))
  }, col_wise_args = list(a = c(3, 2, 1), b = LETTERS[1:3]), row.name = "-")
  

    check_row1(tbl1)

  
  tbl2 <- rtabulate((1:3)>2, factor(letters[1:3]), function(xi, a, b) {
    rcell(list(xi, a, b))
  }, col_wise_args = list(a = c(3, 2, 1), b = LETTERS[1:3]), row.name = "-")
  
  check_row1(tbl2)
  
  check_all_rows <- function(x) {
      for (i in 1:nrow(x)) {
          check_row1(x[i,])
      }
  }
  
  tbl3 <- rtabulate(factor(letters[1:3]), factor(letters[1:3]), function(xi, a, b) {
        ret = as.list(table(xi))
        lapply(ret, function(yi) list(if(yi == 0) "-" else xi, a, b))
  }, col_wise_args = list(a = c(3, 2, 1), b = LETTERS[1:3]), row.name ="-")


  check_all_rows(tbl3)
  
  df <- data.frame(
    v1 = 1:3, v2 = 3:5
  )
  tbl4 <- rtabulate(df, factor(letters[1:3]), row_by = factor(letters[1:3]),  function(df, a, b) {
    rcell(list(nrow(df), a, b))
  }, col_wise_args = list(a = c(3, 2, 1), b = LETTERS[1:3]), row.name = "-")
  
  check_all_rows(tbl4)
  
})

test_that("rtabulate:by_quartile works", {
    AGE = sample(1:80, 400, replace = TRUE)
    dat = data.frame(AGE = AGE,
                     RSP = rnorm(400, AGE/20))
    tbl1 = rtabulate(dat$RSP, by_quartile(dat$AGE), length)
    expect_identical(sum(cells(tbl1)), 400L)

    tbl2 = rtabulate(dat$RSP, by_quartile(dat$AGE, cumulative = TRUE), length, row.name = "")
    expect_identical(cumsum(cells(tbl1)), cells(tbl2))
})


test_that("rtabulate:... passed on correctly", {
    x <- c(1, 2, 3, NA, 3, 2)
    cb <- factor(c("A", "B", "A", "B", "B", "A"))

    tbl <- rtabulate(x, cb, mean, na.rm = TRUE)
    expect_identical(cells(tbl), c(2, 2.5))
})
