---
title: "Introduction to rtables"
author: "Gabriel Becker and Adrian Waddell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rtables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---



```{r, echo=FALSE}
knitr::opts_chunk$set(comment = "")
```

## Introduction

The `rtables` R package provides a framework to create, tabulate and output tables in `R`. Most of the requirements for the design of `rtables` were taken from tables that are commonly used to report analyses from clinical trials, however, we were careful to keep `rtables` a general purpose toolkit. 

There are a number of other table frameworks available in `R` such as [gt](https://gt.rstudio.com/) from RStudio, [xtable](https://cran.r-project.org/web/packages/xtable/index.html), [tableone](https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html) and [tables](https://cran.r-project.org/web/packages/tables/index.html) to name a few. One reason to implement `rtables` was that in order to report clinical trials data the tables are often outputted in ASCII and paginated. `rtables` has further a strong focus on tabulation and organizing and accessing information.

In the remainder of this vignette we give a short introduction into `rtables` and tabulating a table. The content is based on the [useR 2020 presentation from Gabriel Becker](https://www.youtube.com/watch?v=CBQzZ8ZhXLA).

The packages used for this vignettes ar `rtables` and `dplyr`:

```{r, message=FALSE}
library(rtables)
library(dplyr)
```

## data 

The data used in this vignette is a made up using random number generators. The data content is relatively simple: one row per imaginary person and one column per measurement: study arm, the country of origin, gender, handedness, age, and weight.

```{r data}
n <- 400

set.seed(1)

df <- tibble(
  arm = factor(sample(c("Arm A", "Arm B"), n, replace = TRUE), levels = c("Arm A", "Arm B")),
  country = factor(sample(c("CAN", "USA"), n, replace = TRUE, prob = c(.55, .45)), levels = c("CAN", "USA")),
  gender = factor(sample(c("Female", "Male"), n, replace = TRUE), levels = c("Female", "Male")),
  handed = factor(sample(c("Left", "Right"), n, prob = c(.6, .4), replace = TRUE), levels = c("Left", "Right")),
  age = rchisq(n, 30) + 10
) %>% mutate(
  weight = 35 * rnorm(n, sd = .5) + ifelse(gender == "Female", 140, 180)
) 

head(df)
```

Note that we use factors so that the level order is represented in the row or column order in the tabulation that will follow.


## Building an Table

The aim of this vignette is to build the following table step by step:

```{r, echo=FALSE}
basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  add_colcounts() %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x") %>%
  build_table(df)
```

Please take a moment and think about the information packed in this table:

* is the layout intuitive
* what data has been used in which cell
* which summary functions have been used?


* Nested splitting
  - in row space: `split_rows_by`, `split_rows_by_*`
  - in column space: `split_cols_by`, `split_cols_by_*`
* Summarizing Groups: `summarize_row_groups`
* Analyzing Variables: `analyze`, `analyze_against_ref_group`


## Starting Simple

A basic table has one column representing all data and 0 rows. Analyzing a variable is one way of adding a row:

```{r}
l <- basic_table() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```


### Layout Instructions

Note that in the code above we first describe the table and save that description to a variable `l` and then build the table using actual data with `build_data`. The description of a table is called a table layout. `basic_table` is the start of every table layout and contains the information that we have one column representing all data. The `analyze` instructions add to the layout that the `age` variable should be analyzed with the `mean` analysis function and the result should be rounded to `1` precision.

Hence, the layout is "pre-data", that is, we do not need any data to say how to build a table. We can look at the layout isolated: 

```{r}
l
```

The general layouting instructions are summarized below:

* `basic_table` for a table with zero rows and one column
* Nested splitting
  - in row space: `split_rows_by`, `split_rows_by_*`
  - in column space: `split_cols_by`, `split_cols_by_*`
* Summarizing Groups: `summarize_row_groups`
* Analyzing Variables: `analyze`, `analyze_against_baseline`

using those functions it is possible to create a wide variety of tables.


### Adding Column Structure

We will now continue our table example from above by adding more structure to the columns by splitting column space by the levels in the factor defined by the `arm` variable:


```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

We can continue the column space splitting by adding another `split_cols_by` instruction. By default this will add nested splitting. Here we splitting each arm further by the gender:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

So the first column represents the data in `df` where `df$arm == "A" & df$gender == "Female"` and the second column the data in `df` where `df$arm == "A" & df$gender == "Male"` and so on.

### Adding Row Structure

So far we have added analysis information and column structure to the layout. This resulted with a table that has multiple columns and one analysis / data row. We will now continue to add more row structure by further stratifying the mean analysis by country:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

In this table the data used to derive the first cell (average of age of female canadians in arm A) is  where `df$country == "CAN" & df$arm == "Arm A" & df$gender == "Female"`, hence the cell value can also be calculated manually:

```{r}
mean(df$age[df$country == "CAN" & df$arm == "Arm A" & df$gender == "Female"])
```


### Adding Group Information

Often the analysis carried out (mean here) is put into context by summarizing the group information such as by adding the number of observations and percentage of the column data is used in the analyis cells. In `rtables` such group summaries are called content information. In the following table we add the count percentage information for each mean analysis. 
Often a group of dat

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

Note that group information for average age of female canadians is calculated as follows:

```{r}
df_cell <- subset(df, df$country == "CAN" & df$arm == "Arm A" & df$gender == "Female")
df_col_1 <- subset(df, df$arm == "Arm A" & df$gender == "Female")

c(count = nrow(df_cell), percentage = nrow(df_cell)/nrow(df_col_1))
```

so the group percentages sum up to 1 for each column. 

We can further split the column space by dividing each country by handedness:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

and add also add a count and percentage summary for handedness within each country:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

## Adding Column Information

In clinical trials analyses the number of patients per column is often referred to as `N` (rather than the overall population which is often referred to as `N`). In `rtables` it is simple to add this information using the `add_colcounts`:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  add_colcounts() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```


## Summary

In this vignette you have learned a number of things:

* cells represent an analysis or summary on a subset of the overall data
   * this means that much of tabulation has to do with splitting/subsetting data
* tables can be described pre-data using layouts
* tables are a form of visualization of data

The other vignettes in the `rtables` package will provide more detailed information about the `rtables` package. We recommend that you continue with the `tabulation_dplyr` vignette which compares the information derived by the table in this vignette using `dplyr`.



